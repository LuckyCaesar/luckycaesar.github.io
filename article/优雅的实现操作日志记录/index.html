<!DOCTYPE html>
<html lang="zh-CN">

<!-- Head tag -->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <!--Description-->
  

  <!--Author-->
  
  <meta name="author" content="CaesarX">
  

  <!--Open Graph Title-->
  
      <meta property="og:title" content="优雅的实现操作日志记录"/>
  
  <!--Open Graph Description-->
  
  <!--Open Graph Site Name-->
  <meta property="og:site_name" content="三味书屋"/>
  <!--Type page-->
  
      <meta property="og:type" content="article" />
  
  <!--Page Cover-->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- Title -->
  
  <title>优雅的实现操作日志记录 - 三味书屋</title>


  <link rel="shortcut icon" href="/img/rose.png">

  <!-- Custom CSS/Sass -->
  
<link rel="stylesheet" href="/css/style.css">


  <!----------------------------
  https://github.com/GallenHu/hexo-theme-Daily

 _____            _   _
|  __ \          (_) | |
| |  | |   __ _   _  | |  _   _
| |  | |  / _` | | | | | | | | |
| |__| | | (_| | | | | | | |_| |
|_____/   \__,_| |_| |_|  \__, |
                          __/ |
                         |___/

    --------------------------->

<meta name="generator" content="Hexo 6.2.0"></head>


<body>

  <!-- Nav -->
  <header class="site-header">
  <div class="header-inside">
    <div class="logo">
      <a href="/" rel="home">
        
        <img src="/img/kobe.jpg" alt="三味书屋" height="60">
        
      </a>
    </div>
    <!-- Navigation -->
    <nav class="navbar">
      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse">
        <ul class="navbar-nav">
          
          
            <li>
              <a href="/.">
                
                  首页
                
              </a>
            </li>
          
            <li>
              <a href="/archives">
                
                  归档
                
              </a>
            </li>
          
            <li>
              <a href="/about">
                
                  关于
                
              </a>
            </li>
          
        </ul>
      </div>
      <!-- /.navbar-collapse -->
    </nav>
    <div class="button-wrap">
      <button class="menu-toggle">Primary Menu</button>
    </div>
  </div>
</header>


  <!-- Main Content -->
  <div class="content-area">
  <div class="post">
    <!-- Post Content -->
    <div class="container">
      <article>
        <!-- Title date & tags -->
        <div class="post-header">
          <h1 class="entry-title">
            优雅的实现操作日志记录
            
          </h1>
          <p class="posted-on">
          2022-08-22
          </p>
          <div class="tags-links">
            
              
                <a href="/tags/SpEL/" rel="tag">
                  SpEL
                </a>
              
                <a href="/tags/FunctionalInterface/" rel="tag">
                  FunctionalInterface
                </a>
              
                <a href="/tags/ThreadLocal/" rel="tag">
                  ThreadLocal
                </a>
              
            
          </div>
        </div>
        <!-- Post Main Content -->
        <div class="entry-content has_line_number">
          <blockquote>
<p>参考文章：<a target="_blank" rel="noopener" href="https://tech.meituan.com/2021/09/16/operational-logbook.html">https://tech.meituan.com/2021/09/16/operational-logbook.html</a></p>
</blockquote>
<h2 id="背景"><a class="markdownIt-Anchor" href="#背景"></a> 背景</h2>
<p>最近参与了系统的重构，新的版本，需要对以前操作日志的实现进行改动，以前的操作日志是基于注解实现的，能记录单据类型、操作人、操作时间、操作描述、请求参数等。现在新的日志记录需要支持更多：</p>
<ul>
<li>新增业务唯一标识记录，即<strong>业务单号</strong>；</li>
<li>操作描述支持<strong>动态参数</strong>填入，支持<strong>动态函数</strong>的执行和替换；</li>
<li>针对比较多字段编辑的场景，需记录更新前的<strong>原始数据</strong>。</li>
</ul>
<p>于是参考了美团的这篇文章，重新实现了解析操作日志的逻辑。至于操作日志的必要性以及简单实现等就不过多赘述，原文有更详细的描述，这里重点说一下对于几个新增需求的实现。</p>
<h2 id="实现"><a class="markdownIt-Anchor" href="#实现"></a> 实现</h2>
<h3 id="自定义注解"><a class="markdownIt-Anchor" href="#自定义注解"></a> 自定义注解</h3>
<p>先看看日志注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DataLog &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单笔数据操作时可指定，SpEL.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">billId</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单据类型，所属的业务模块，一般指定为固定值.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">billType</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作描述，支持SpEL模板，支持自定义函数.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">operationDesc</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询更新操作的原始数据时自定义函数名称，根据billId查询.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">originalDataFunction</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义函数执行时可选的分表字段值，SpEL.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">shardingId</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注解里面需要用到SpEL，对于动态获取参数字段值，首选的当然是SpEL表达式语言，简单强大。这里面billId、operationDesc、shardingId都需要从参数中动态取值的，而接口的参数会有两种情况，一种是多个参数，一种是整个对象作为请求body的单个参数。</p>
<p>注解使用示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多个参数值</span></span><br><span class="line"><span class="meta">@GetMapping(value = &quot;/query&quot;)</span></span><br><span class="line"><span class="meta">@DataLog(billId = &quot;#&#123;#id&#125;&quot;,</span></span><br><span class="line"><span class="meta">         shardingId = &quot;#&#123;#id&#125;&quot;,</span></span><br><span class="line"><span class="meta">         billType = &quot;test&quot;,</span></span><br><span class="line"><span class="meta">         operationDesc = &quot;id为#&#123;#id&#125;. id2为#&#123;#id2&#125;&quot;,</span></span><br><span class="line"><span class="meta">         originalDataFunction = &quot;prefix&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResultVO&lt;String&gt; <span class="title function_">query</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> String id, <span class="meta">@RequestParam(&quot;id2&quot;)</span> String id2)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ResultUtils.success(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单个对象请求</span></span><br><span class="line"><span class="meta">@PostMapping(value = &quot;/post&quot;)</span></span><br><span class="line"><span class="meta">@DataLog(billId = &quot;#&#123;id&#125;&quot;,</span></span><br><span class="line"><span class="meta">         shardingId = &quot;#&#123;id&#125;&quot;,</span></span><br><span class="line"><span class="meta">         billType = &quot;test&quot;,</span></span><br><span class="line"><span class="meta">         operationDesc = &quot;id是#&#123;id!=null?id:&#x27;默认值&#x27;&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResultVO&lt;String&gt; <span class="title function_">post</span><span class="params">(<span class="meta">@RequestBody</span> TestDTO dto)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ResultUtils.success(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>针对多参数的情况，取值的写法看起来有些奇怪，这是因为同时使用了SpEL的 <code>StandardEvaluationContext</code>和<code>TemplateParserContext</code>，这样做也是为了能兼容操作描述中的<strong>模板表达式</strong>的写法。</p>
<h3 id="spel实现动态参数获取"><a class="markdownIt-Anchor" href="#spel实现动态参数获取"></a> SpEL实现动态参数获取</h3>
<p>核心代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExpressionParser</span> <span class="variable">PARSER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpelExpressionParser</span>();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">LocalVariableTableParameterNameDiscoverer</span> <span class="variable">DISCOVERER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LocalVariableTableParameterNameDiscoverer</span>();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;StandardEvaluationContext&gt; CONTEXT_THREAD_LOCAL = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">templateParse</span><span class="params">(String text, Method method, Object[] argsObj)</span> &#123;</span><br><span class="line">    String[] parameterNames = DISCOVERER.getParameterNames(method);</span><br><span class="line">    <span class="keyword">if</span> (parameterNames == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> text;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 由于存在业务操作执行前后都要进行解析的场景，所以使用ThreadLocal存储上下文的context，避免重复创建</span></span><br><span class="line">    <span class="type">StandardEvaluationContext</span> <span class="variable">context</span> <span class="operator">=</span> CONTEXT_THREAD_LOCAL.get();</span><br><span class="line">    <span class="keyword">if</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> PARSER.parseExpression(text, <span class="keyword">new</span> <span class="title class_">TemplateParserContext</span>()).getValue(context, String.class);</span><br><span class="line">    &#125;</span><br><span class="line">    context = <span class="keyword">new</span> <span class="title class_">StandardEvaluationContext</span>();</span><br><span class="line">    <span class="comment">// 把接口的所有参数都放到context中</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; parameterNames.length; i++) &#123;</span><br><span class="line">        context.setVariable(parameterNames[i], argsObj[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取对象中的属性值时，使用第一个参数作为rootObject</span></span><br><span class="line">    context.setRootObject(argsObj[<span class="number">0</span>]);</span><br><span class="line">    CONTEXT_THREAD_LOCAL.set(context);</span><br><span class="line">    <span class="comment">// 结合使用`模板`和`标准`的表达式解析</span></span><br><span class="line">    <span class="keyword">return</span> PARSER.parseExpression(text, <span class="keyword">new</span> <span class="title class_">TemplateParserContext</span>()).getValue(context, String.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeContext</span><span class="params">()</span> &#123;</span><br><span class="line">    CONTEXT_THREAD_LOCAL.remove();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="动态函数的执行和替换"><a class="markdownIt-Anchor" href="#动态函数的执行和替换"></a> 动态函数的执行和替换</h3>
<p>注解使用的方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(value = &quot;/post2&quot;)</span></span><br><span class="line"><span class="meta">@DataLog(billId = &quot;#&#123;id&#125;&quot;,</span></span><br><span class="line"><span class="meta">         shardingId = &quot;#&#123;id&#125;&quot;,</span></span><br><span class="line"><span class="meta">         billType = &quot;test&quot;,</span></span><br><span class="line"><span class="meta">         operationDesc = &quot;id是#&#123;id!=null?id:&#x27;默认值&#x27;&#125;，自定义动态函数@customeFunction(#&#123;id&#125;,#&#123;name&#125;)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResultVO&lt;String&gt; <span class="title function_">post2</span><span class="params">(<span class="meta">@RequestBody</span> TestDTO dto)</span> &#123;</span><br><span class="line">    List&lt;SnEntity&gt; snEntities = snTestMapper.selectList(Wrappers.lambdaQuery(SnEntity.class));</span><br><span class="line">    <span class="keyword">return</span> ResultUtils.success(snEntities.get(<span class="number">0</span>).getPeriodName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>动态函数的使用主要是在 <strong>操作描述(operationDesc)</strong> 中，由于某些场景下需要填充一些动态查询的数据到描述中去，故需要支持。这个地方按照原文的思路来做是可以使用<code>MethodBasedEvaluationContext</code>来实现，而<code>StandardEvaluationContext</code>是<code>MethodBasedEvaluationContext</code>的父类，所以也可以使用<code>StandardEvaluationContext#registerFunction</code>函数来进行注册。但这需要获取目标类的Method信息作为参数，感觉比较麻烦，所以我并没有使用这种方法，而是自定义了函数式接口进行注册，先看看自定义函数以及注册的方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 函数式接口，便于实现自定义的逻辑</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IFunction</span>&lt;R&gt; &#123;</span><br><span class="line">    <span class="comment">// 动态入参（这里的设计或许不够好）</span></span><br><span class="line">    R <span class="title function_">apply</span><span class="params">(String... params)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogParseFunctionFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, IFunction&lt;Object&gt;&gt; FUNCTION_MAP = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作日志自定义函数注册.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> functionName 函数名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> function     函数体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerFunction</span><span class="params">(String functionName, IFunction&lt;Object&gt; function)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!FUNCTION_MAP.containsKey(functionName)) &#123;</span><br><span class="line">            FUNCTION_MAP.put(functionName, function);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现与注册逻辑</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceRegistry</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BizMapper bizMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">initRegistry</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 注册自定义函数，customeFunction对应描述中的函数名称</span></span><br><span class="line">        LogParseFunctionFactory.registerFunction(<span class="string">&quot;customeFunction&quot;</span>, (params) -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> bizMapper.query(params[<span class="number">0</span>]);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析函数名称、执行函数并进行结果替换：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 约定函数声明的格式，形如 @functionName(param0,param1)，其中的param可以通过SpEL进行注入，也可以固定</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">char</span> <span class="variable">AT</span> <span class="operator">=</span> <span class="string">&#x27;@&#x27;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">char</span> <span class="variable">LEFT_BRACKET</span> <span class="operator">=</span> <span class="string">&#x27;(&#x27;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">char</span> <span class="variable">RIGHT_BRACKET</span> <span class="operator">=</span> <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WHITESPACE</span> <span class="operator">=</span> <span class="string">&quot; &quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EMPTY</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">COMMA</span> <span class="operator">=</span> <span class="string">&quot;,&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">functionParse</span><span class="params">(String text)</span> &#123;</span><br><span class="line">    <span class="type">char</span>[] chars = text.toCharArray();</span><br><span class="line">    <span class="comment">// 由于需要对占位的函数进行结果替换，需要新字符串，预先扩展一部分空间，避免循环中不必要的扩容操作。空间换时间</span></span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(text.length() + (text.length() / <span class="number">2</span>));</span><br><span class="line">    <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; chars.length; i++) &#123;</span><br><span class="line">        <span class="type">char</span> <span class="variable">ch</span> <span class="operator">=</span> chars[i];</span><br><span class="line">        <span class="keyword">if</span> (AT != ch) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析自定义函数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (j &lt; chars.length &amp;&amp; chars[j] != LEFT_BRACKET) &#123;</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">funcName</span> <span class="operator">=</span> doParse(chars, j, i);</span><br><span class="line">        <span class="comment">// 解析函数参数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">l</span> <span class="operator">=</span> j;</span><br><span class="line">        <span class="keyword">while</span> (j &lt; chars.length &amp;&amp; chars[j] != RIGHT_BRACKET) &#123;</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">params</span> <span class="operator">=</span> doParse(chars, j, l);</span><br><span class="line">        IFunction&lt;Object&gt; function = LogParseFunctionFactory.FUNCTION_MAP.get(funcName.trim());</span><br><span class="line">        <span class="keyword">if</span> (function == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 替换空白，使用apache lang包的replace方法，性能更佳</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">actualParams</span> <span class="operator">=</span> StringUtils.replace(params, WHITESPACE, EMPTY);</span><br><span class="line">        <span class="comment">// 执行动态函数</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">funcResult</span> <span class="operator">=</span> function.apply(actualParams.split(COMMA));</span><br><span class="line">        <span class="comment">// 替换动态函数为执行的结果</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">replacement</span> <span class="operator">=</span> (funcResult == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : funcResult.toString());</span><br><span class="line">        builder.append(text, offset, i).append(replacement);</span><br><span class="line">        offset = j + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    builder.append(text, offset, text.length());</span><br><span class="line">    <span class="keyword">return</span> builder.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">doParse</span><span class="params">(<span class="type">char</span>[] chars, <span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">    <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[x - <span class="number">1</span> - y];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; (x - <span class="number">1</span> - y); k++) &#123;</span><br><span class="line">        bytes[k] = (<span class="type">byte</span>) chars[y + <span class="number">1</span> + k];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="更新前原始数据的获取"><a class="markdownIt-Anchor" href="#更新前原始数据的获取"></a> 更新前原始数据的获取</h3>
<p>这里要用到的是注解里面的<code>originalDataFunction</code>字段，函数的注册方式同上，只是在调用的地方不太一样，是在操作执行前调用的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="meta">@PostMapping(value = &quot;/post&quot;)</span></span><br><span class="line"><span class="meta">@DataLog(billId = &quot;#&#123;id&#125;&quot;,</span></span><br><span class="line"><span class="meta">         shardingId = &quot;#&#123;id&#125;&quot;,</span></span><br><span class="line"><span class="meta">         billType = &quot;test&quot;,</span></span><br><span class="line"><span class="meta">         originalDataFunction = &quot;originalFunction&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResultVO&lt;String&gt; <span class="title function_">post</span><span class="params">(<span class="meta">@RequestBody</span> TestDTO dto)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ResultUtils.success(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析执行逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注解获取等</span></span><br><span class="line">...</span><br><span class="line"><span class="type">String</span> <span class="variable">originalData</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// 判断是否指定了自定义函数且单号必须指定</span></span><br><span class="line"><span class="keyword">if</span> (StrUtil.isNotBlank(logHandler.originalDataFunction) &amp;&amp; StrUtil.isNotBlank(logHandler.billId)) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">finalBillId</span> <span class="operator">=</span> ExpressionHandler.templateParse(logHandler.billId, logHandler.method, argsObj);</span><br><span class="line">        <span class="type">String</span> <span class="variable">shardingId</span> <span class="operator">=</span> ExpressionHandler.templateParse(logHandler.shardingId, logHandler.method, argsObj);</span><br><span class="line">        <span class="comment">// 自定义函数查询原始数据，也是用的上面的函数注册方法</span></span><br><span class="line">        IFunction&lt;Object&gt; function = LogParseFunctionFactory.FUNCTION_MAP.get(logHandler.originalDataFunction);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">originalDataObject</span> <span class="operator">=</span> Optional.ofNullable(function)</span><br><span class="line">            .map(f -&gt; f.apply(finalBillId, shardingId))</span><br><span class="line">            .orElse(<span class="literal">null</span>);</span><br><span class="line">        originalData = JsonSerializer.serialize(originalDataObject);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        Log.warn(ex, <span class="string">&quot;日志内容补充originalData失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 业务操作</span></span><br><span class="line">    <span class="keyword">return</span> (result = joinPoint.proceed());</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    <span class="comment">// 异常处理，记录错误信息</span></span><br><span class="line">    ...</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// 同步解析注解上的其他值，最终再交给线程池异步写入数据库，这里没有把解析处理的逻辑也异步化</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是由于原始数据一般都是全量的整条数据，会造成日志表的数据膨胀，且必须在操作前查询，也会影响接口性能，所以需要慎用。</p>
<h2 id="可能的优化点"><a class="markdownIt-Anchor" href="#可能的优化点"></a> 可能的优化点</h2>
<p>上面的SpEL解析代码中使用到了<code>ThreadLocal</code>，目前<strong>解析注解是同步处理</strong>，写数据才进入到<strong>线程池异步写</strong>，虽然实测性能问题不大，但是这里可以扩展优化一下，把解析注解值的过程也搬到线程池中去，这里就涉及到如何在线程池异步的场景下使用<code>ThreadLocal</code>？答案是阿里开源的<a target="_blank" rel="noopener" href="https://github.com/alibaba/transmittable-thread-local"><code>TransmittableThreadLocal</code></a>。</p>

        </div>
      </article>
    </div>
    <!-- Comments -->
    <div class="container">
      
<section id="comment">
  <!-- <h1 class="title">留言</h1> -->

  
</section>


    </div>
    <!-- Pre or Next -->
    <div class="nav-links">
      
        <div class="nav-previous">
          <a href="/article/函数式编程增强库vavr初探/" rel="prev"><span class="meta-arraw meta-arraw-left"></span> 上一页</a>
        </div>
      
      
        <div class="nav-next">
          <a href="/article/一种敏感词检测算法-DFA/" rel="prev">下一页 <span class="meta-arraw meta-arraw-right"></span></a>
        </div>
      
    </div>

  </div>
</div>


  <!-- Footer -->
  <!-- Footer-widgets -->
<div class="footer-widgets">
  <div class="row inside-wrapper">
    <div class="col-1-3">
      <aside>
        <h3 class="widget-title">关于本站</h3>
        <div class="custom-widget-content">
          
          学而不思则罔，思而不学则殆。
        </div>
      </aside>
    </div>
    <div class="col-1-3">
      <aside>
        <h3 class="widget-title">与我联系</h3>
        <div class="widget-text">
          
            
              <a href="https://github.com/LuckyCaesar" class="icon icon-github" target="_blank">github</a>
            
          
        </div>
      </aside>
    </div>
    <div class="col-1-3">
      <aside>
        <h3 class="widget-title">站内搜索</h3>
        <div class="widget-text">
          <form onSubmit="return appDaily.submitSearch('')">
            <p>
              <input type="text" placeholder="search..." id="homeSearchInput">
            </p>
            <!-- <input type="submit" value="GO"> -->
          </form>
        </div>
      </aside>
    </div>
  </div>
</div>
<!-- Footer -->
<footer class="site-info">
  <p>
    <span>三味书屋 &copy; 2022</span>
    
      <span class="split">|</span>
      <span>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> with Theme <a href="https://github.com/GallenHu/hexo-theme-Daily" target="_blank">Daily</a></span>
    
  </p>
</footer>


  <!-- After footer scripts -->
  <!-- scripts -->

<script src="/js/app.js"></script>






</body>

</html>
